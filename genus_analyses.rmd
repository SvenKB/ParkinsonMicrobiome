---
title: "Genus level analyses"
author: "Sven Kleine Bardenhorst"
date: "`r format(Sys.time(), '%d %B %Y')`"
mail: "s.kleinebardenhorst@uni-muenster.de"
twitter: "r_graph_gallery"
github: "svenkb"
home: "epi.uni-muenster.de"
# !!! You need to provide a logo image here !!! Or just delete the field for no logo
logo: "Logo_WWU.svg"
output:
  epuRate::epurate:
    toc: TRUE
    number_sections: FALSE
    code_folding: "hide"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE,fig.width = 12)
```

```{css include=FALSE}
body .main-container {
max-width: 1600px;
}
```

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

```{r load packages, message=FALSE, warning=FALSE, include=FALSE}
#### load packages ####
source('packages.R')

#### load functions ####
source("functions.R")
```

# Beta diversity 

## Prepare full distance matrix

```{r echo=FALSE, message=FALSE}
dat <- readRDS("phyl_list.RDS")

beta <- prepare_beta_data(dat,tax="Phylum",method = "bray")
```

```{r}
cmdscale(beta$dist,k=2) %>%
  as.data.frame() %>%
  rownames_to_column("ID") %>%
  dplyr::left_join(beta$meta) %>%
  ggplot(aes(x=V1,y=V2,col=author,shape=status)) +
  geom_point()




beta_NMDS <- metaMDS(as.matrix(beta$dist,labels = T),distance = "bray",
                     k=2,
                     maxit = 999)


stressplot(beta_NMDS)
plot(beta_NMDS)
```

+
```{r}
fit <- adonis(beta$dist~status,data = beta$meta,strata = beta$meta$author,permutations = 1000)

```

```{r}
boxplot(betadisper(beta$dist,as.factor(beta$meta$author)))

```

## Differential abundance
```{r}
full.dat <- prepare_DA_data(dat,tax="Family")
full.dat <- full.dat %>% dplyr::select(ID,status,author,N,everything())
```



## Permutation based differential abundance
```{r}
otu <- full.dat %>% dplyr::select(-c(1:4))
meta <- full.dat %>% dplyr::select(c(1:4))

group <- meta$status
strata <- meta$author
weights <- meta$N


cores <- detectCores()-2
cl <- makeCluster(cores)
clusterEvalQ(cl, library("permute"))

perm.p <- parApply(cl=cl,otu,2,perm_DA,group=group,type="mean",n.perm=9999,strata=strata,plot=F)

stopCluster(cl)

perm.p <- data.frame(names=names(perm.p),matrix(unlist(perm.p),nrow=length(perm.p),byrow=T))
colnames(perm.p) <- c("Genera","p.value","log.mean.diff")


perm.p$q.value <- p.adjust(perm.p$p.value,method = "fdr")\
perm.p <- perm.p %>% mutate(mean.ratio = exp(log.mean.diff)) %>% arrange(q.value)

perm.p[perm.p$Genera == "Ruminococcaceae",]



full.dat %>%
  #dplyr::select(author,status,Parvimonas) %>%
  group_by(author,status) %>%
  summarize(sum(Ruminococcaceae))

```

